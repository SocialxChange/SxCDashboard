---
title: "AngloAmerican"
author: "SxC"
date: "14/11/2018"
output: html_document
runtime: shiny
---


```{r, echo=FALSE}
## Se incluyen logos al reporte
htmltools::img(src = knitr::image_uri(rep("~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/SxC.jpg", 1)),  
               alt = 'SxC', 
               style = 'position:absolute; top:0; right:0; padding:10px;')
htmltools::img(src = knitr::image_uri(rep("~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Anglo/logo_anglo.png", 1)),  
               alt = 'SxC', 
               style = 'position:absolute; top:0; left:0; padding:10px;')
```

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

#library(formattable)
library(plotly)
library(readr)
library(knitr)
library(ggmap)
library(tmap)
library(readxl)
library(rgdal)
library(GISTools)
library(RColorBrewer)
library(shiny)
library(DT)

## Se debe cargar base con donaciones totales
setwd("~/Documents/SxC-ETL/Donaciones/DonacionesFM")

## Se incluye logo de SxC 

load("20180920Donaciones2009_2016.RData")
Sys.setlocale("LC_ALL", 'UTF-8')

#Correccion de columna año por "Year y MontoTotal
colnames(Donaciones_total)[8]<-"MontoTotal"
colnames(Donaciones_total)[9] <- "Year"


Donaciones_total$MontoTotal<-as.numeric(Donaciones_total$MontoTotal)

## Se crea subconjunto de donaciones, con aquellas realizadas por Donante bajo analisis= Anglo
Donaciones_totalAnglo<-subset(Donaciones_total, DONANTE=="Anglo American Sur S.A."| DONANTE=="Anglo American Sur S.A" | DONANTE=="Anglo American Chile Ltda." | DONANTE=="Anglo American Norte S.A.")
Donaciones_Anglo<-Donaciones_totalAnglo[,c(1,2,3,4,7,8,9)]
```


```{r cambios, include=FALSE}

colnames(Donaciones_Anglo)[4]<-"Tematica"


### Creando tematicas para proyectos ###
Donaciones_Anglo$Tematica <- ifelse(Donaciones_Anglo$DONATARIO=="Fundación de Beneficencia Ayuda y Esperanza", "Emprendimiento", Donaciones_Anglo$Tematica)
Donaciones_Anglo$Tematica <- ifelse(Donaciones_Anglo$DONATARIO=="Fundación Un Techo para Chile", "Vivienda", Donaciones_Anglo$Tematica)
Donaciones_Anglo$Tematica <- ifelse(Donaciones_Anglo$DONATARIO=="Fundación Enseña Chile", "Educacion", Donaciones_Anglo$Tematica)
Donaciones_Anglo$Tematica <- ifelse(Donaciones_Anglo$DONATARIO=="Fundación TechnoServe" | Donaciones_Anglo$DONATARIO=="Fundación Technoserve Chile" | Donaciones_Anglo$DONATARIO=="Fundación TechnoServe Chile", "Emprendimiento", Donaciones_Anglo$Tematica)
Donaciones_Anglo$Tematica <- ifelse(Donaciones_Anglo$DONATARIO=="Corporación La Montaña", "Medio Ambiente", Donaciones_Anglo$Tematica)
Donaciones_Anglo$Tematica <- ifelse(Donaciones_Anglo$DONATARIO=="Fundación Mi Parque", "Medio Ambiente", Donaciones_Anglo$Tematica)

### Pasando cifras a $MM
Donaciones_Anglo$MontoTotal<-Donaciones_Anglo$MontoTotal/1000000

Donaciones_Anglo_Tematica<-aggregate(MontoTotal ~ Tematica, data=Donaciones_Anglo, sum)
Donaciones_Anglo_Tematica$percent = round(100*Donaciones_Anglo_Tematica$MontoTotal/sum(Donaciones_Anglo_Tematica$MontoTotal), digits = 1)
Donaciones_Anglo_Tematica_Ano<-aggregate(MontoTotal ~ Tematica + Year, data=Donaciones_Anglo, sum)
Donaciones_donatario<-aggregate(MontoTotal ~ DONATARIO + Year, data=Donaciones_Anglo, sum)
Donaciones_donatarioRank<-Donaciones_donatario[order(-Donaciones_donatario$MontoTotal),]

Suma_Donaciones_Anglo<-aggregate(MontoTotal ~ DONATARIO + Year, data=Donaciones_Anglo,sum)
Suma_Total_ano<-aggregate(MontoTotal ~ Year, data=Donaciones_Anglo,sum)


base1 <- (merge(Suma_Donaciones_Anglo, Suma_Total_ano, by = 'Year'))
base1$pct<-(base1$MontoTotal.x/base1$MontoTotal.y)
Donaciones_anglo_pct<-merge(Donaciones_donatarioRank,base1, by.x=c("DONATARIO","Year"), by.y=c("DONATARIO","Year"))
aux<-Donaciones_anglo_pct[,-(4:5)]

## Ajustando decimales de la futura tabla
RankingAnglo<-format(aux, digits=2, nsmall=3)

#Formateando a porcentajes
#RankingAnglo$pct<-percent(RankingAnglo$pct)


## En dolares a Sept 13: 685
#Donaciones_donatarioRank$MontoTotal<-Donaciones_donatarioRank$MontoTotal/685
```

# 1. Introducción

Este es el informe tipo de SocialxChange para nuestro clientes, en este se incluye un breve análisis de los programas y temáticas en las que nuestros clientes estan donando, del desempeño social de los programas realizados de manera directa o a través de la gestión de terceras parte y recomendaciones para aumentar su impacto social.

En el caso de Anglo American, la gestión social se basa en "The Anglo American Social Way", que tiene por objeto evitar, prevenir, y mitigar los impactos sociales del giro de la compañia. Estas acciones se realizan al alero del Socio Economic Assessment Toolbox, SEAT. 

La siguiente tabla muestra las donaciones realizadas por Anglo desde 2009 a 2016, donde se aprecian los montos de las donaciones por año a cada institución, y los porcentajes de montos respecto a cada año. En términos de monto, la Fundación de Beneficiencia Ayuda y Esperanza (Fondo Esperanza) es la que recibe el mayor monto y que se explica por el terremoto de 2010. En la tabla se ve el trabajo continuo realizado por Anglo en lo que se refiere a emprendimiento y su programa estrella Emerge, el cual es ejecutado por Technoserve desde 2006. 

Por último, en la tabla nº1 se observa que las donaciones de Anglo American registradas en el MDS solo se concentran en 6 beneficiarios; Corporación la Montaña, Enseña Chile, Mi Parque, Techo, Technoserve y Fondo Esperanza. 


```{r echo = FALSE, results = 'table'}
#kable(Donaciones_donatarioRank[,], caption = "Tabla 1: Donaciones por Institución Beneficiaria, 2009-2016, MM de pesos")

shinyApp(
  ui = fluidPage(DTOutput('tbl')),
  server = function(input, output) {
    output$tbl = renderDT(
      RankingAnglo, options = list(lengthChange = FALSE), rownames=FALSE, caption = "Tabla 1: Donaciones por Institución Beneficiaria, MM$") 
  }
)
```

# 1.1. Donaciones georefenrenciadas

En el mapa podemos observar los programas y su ubicacioón a nivel nacional. La data georefenciada muestra que las donaciones se sitúan en la región de Antofagasta, Metropolitana, Maule y Bio Bio, siendo la región Metropolitana la con mayor intervención de proyectos. 


```{r setup maps, include=FALSE}

## Importar base sin georeferencia
angloamerican <- read.csv("~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Anglo/angloamerican.csv", comment.char="#")

#### Esto queda para conocimento, pero no se ejecuta al correr el markdown

# Loop through the addresses to get the latitude and longitude of each address and add it to the
# origAddress data frame in new columns lat and lon
#for(i in 1:nrow(angloamerican)){
  # Print("Working...")
  #result <- geocode(paste(angloamerican$city[i], angloamerican$state[i],", Chile",sep=""), output = "latlona", source = "google")
  #angloamerican$lon[i] <- as.numeric(result[1])
  #angloamerican$lat[i] <- as.numeric(result[2])
#}

## exportartando base
#Anglogeo <- read_excel("~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Anglo/Anglo.xlsx")


# Write a CSV file containing origAddress to the working directory
#write.csv(result, "geocoded.csv", row.names=FALSE)


# CRS for the US National Atlas Map. Se debe cambiar a lo que corresponde a Chile
us.atlas.proj <- CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs")
#CRS for the US in WGS 1984 (world geographic 1984)
wgs1984.proj <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")


# Reconociendo Shapefiles de Chile y Anglo
list.files('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile', pattern='\\.shp$')
file.exists('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile/__CHL_adm2.shp')
Chile0<-readOGR(dsn=path.expand('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile'), layer="CHL_adm0")
Chile1<-readOGR(dsn=path.expand('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile'), layer="CHL_adm1")
Chile2<-readOGR(dsn=path.expand('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile'), layer="CHL_adm2")

## Shapefiles anglo
list.files('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile/anglo_geo', pattern='\\.shp$')
file.exists('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile/anglo_geo/anglo_geo.shp')
anglogeo<-readOGR(dsn=path.expand('~/Documents/SxC-ETL/Donaciones/DonacionesFM/Reportes/Mapas_Chile/anglo_geo'), layer="anglo_geo")

### proyectando los shapefile
# project the us shapefile
proj4string(Chile1) <- wgs1984.proj
# Proyectando a Chile equal-area projection
Chile1.equal <- spTransform(Chile1, us.atlas.proj)

anglogeo1<-subset(anglogeo, anglogeo$lat != "NA")
anglogeo1<-subset(anglogeo, anglogeo$lon != "NA")
anglogeo2 <- SpatialPoints(coords=anglogeo1[,c(14,15)], proj4string=wgs1984.proj)
```


```{r mapas, results="mapas",  echo=FALSE}

par(mfcol=c(1,1))
plot(anglogeo2, pch=20, col="red", cex=1, main="Donaciones Anglo")
plot(Chile1, add=TRUE)

## Esto visualiza mapa en el mismo codigo, pero no se muestra en reporte [Revisar] ##
# World_small <- tmap_format("World")
# World_small$scale <- 2
# 
# # add format
# tmap_format_add(World_small, name = "World_small")
# 
# suppressMessages(tmap_mode("view"))
# mapa<-print(qtm(anglogeo1, "NAME", fill.title="tematica", format = "NLD"))

```

# 1.2. Estadisticas

En los siguientes gráficos se ve las donaciones realizadas por Anglo American por año y por filial en el marco de la ley de donaciones sociales. Se observa que desde 2009 a la fecha, existio un peak en terminos de monto de donaciones entre 2010 y 2011, que puede haber sido causado por el terremoto. En terminos del promedio de montos, estos se situan en el rango de 0 a 100 millones.


```{r ScatterPlot, echo=FALSE}
library(ggplot2)
ggplot(Donaciones_Anglo, aes(Year,MontoTotal, color=DONANTE))+
  geom_point()
```

Un análisis similar se puede hacer al revisar los montos de donaciones anuales por tematica. Se observa peaks de donaciones, en términos de  monto, en los año 2010 y 2011 en tematicas relacionadas a emprendimiento y vivienda lo que esta altamente correlacionado con el terremoto de 2010. Un dato interesante es que a partir de 2011 hay considerables montos de donaciones destinados a Medio Ambiente con donaciones destinadas a la Corporación la Montaña y la Fundación Mi Parque. 

```{r ScatterPlot2, echo=FALSE}
ggplot(Donaciones_Anglo_Tematica_Ano, aes(Year,MontoTotal, color=Tematica))+
  geom_point()
```

Por su parte al revisar los gráficos  de torta para las donaciones totales desde 2009 a 2016, la tematica con mayor inversioón social por parte de la compañia ha sido el emprendimiento (Technoserve y Fondo Esperanza), seguida por Medio Ambiente, Educación y Vivienda. Es interesante notar que no se observa apoyo a otras tematicas relevantes a nivel nacional como son programas destinados a familias, niños o salud.

```{r PieChart, echo=FALSE}
# Prueba: Pie Chart de Anglo American
p <- plot_ly(Donaciones_Anglo_Tematica, labels = ~Tematica, values = ~MontoTotal, type = 'pie') %>%
  layout(title = 'Donaciones por tematica AngloAmerican',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
p
```


En el gráfico de continuación se observa la evoluación de montos por anño, por temática. Es interesante notar que Anglo invirtió en temáticas de Vivienda sólo entre los años 2010 y 2011;  Educación entre los años 2011 a 2016; Emprendimiento, que destaca por montos y por estar presente todos los años a excepción del año 2015. 

```{r tematica, echo=FALSE}
# Prueba: Bar Plot de Anglo American por año y tematica 
ggplot(data = Donaciones_Anglo_Tematica_Ano, aes(x = Year, y = MontoTotal, fill = Tematica)) + 
  geom_bar(stat = "identity")
```

# 2. Indicadores Proyectos

A continuación se ven los indicadores más recientes para las instituciones apoyadas por AngloAmerican. En la tabla se observa los indicadores de empleados Full-Time a Part-Time; Sostenibilidad Financiera; Eficiencia de Fundraising; Pasivos a Activos; y el ratio de Capital de Trabajo. 

```{r echo = FALSE, results = 'table'}

donatarios_indicadores<-data.frame(levels(as.factor(Donaciones_Anglo$DONATARIO)))
colnames(donatarios_indicadores)[1]<-"Entidad"

#Incluyendo indicadores por proyecto apoyado
donatarios_indicadores$LtoV<-c(0.01,NA,NA,5,6,7)
donatarios_indicadores$SostFinanciera<-"N/A"
donatarios_indicadores$Fundraising<-"N/A"
donatarios_indicadores$PtoA<-"N/A"
donatarios_indicadores$CapTrab<-"N/A"

#Cambiando nombre de primera columna
# names(donatarios_indicadores)[1]<-paste("Organizacion")
# 
# kable(donatarios_indicadores[,], caption = "Tabla 2: Indicadores Donatarios")

shinyApp(
  ui = fluidPage(DTOutput('tbl')),
  server = function(input, output) {
    output$tbl = renderDT(
      donatarios_indicadores, options = list(lengthChange = FALSE), rownames=FALSE, caption = "Tabla 2: Indicadores Donatarios") 
  }
)


```


# 3. Portfolio de Inversiones

En esta sección se muestra el portfolio de inversiones sociales de Anglo y el benchmarking de otras entidades con sus respectivos indicadores de impacto social.

Nota indicadores computados con datos publicos y FECUs sociales
