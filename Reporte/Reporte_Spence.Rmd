---
title: "BHP Spence"
author: "SxC"
date: "14/05/2020"
output: html_document
runtime: shiny
---


```{r, echo=FALSE}
## Se incluyen logos al reporte
htmltools::img(src = knitr::image_uri(rep("~/Documents/SxCDashboard/Reporte/Logos/SxC.jpg", 1)),  
               alt = 'SxC', 
               style = 'position:absolute; top:0; right:0; padding:10px;')
htmltools::img(src = knitr::image_uri(rep("~/Documents/SxCDashboard/Reporte/Logos/FJE.png", 1)),  
               alt = 'SxC', 
               style = 'position:absolute; top:0; center:0; padding:10px;')
htmltools::img(src = knitr::image_uri(rep("~/Documents/SxCDashboard/Reporte/Logos/BHP.jpeg", 1)))
```

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

#library(formattable)
library(DBI)
library(broom)
library(dplyr)
library(fuzzyjoin)
library(generics)
library(gtools)
library(geosphere)
library(lubridate)
library(modelr)
library(reprex)
library(rvest)
library(selectr)
library(tidyverse)

## Se debe cargar base con donaciones totales
setwd("~/Documents/SxCDashboard")

## Se incluye logo de SxC 

#source("datos/global_tablas.R")
source("datos/ETL_Carreras.R")

```


# 1. Introducción

Este es el reporte tipo de SocialxChange para nuestro clientes, en este se incluye un breve análisis del entorno donde opera Minera Spence entregando algunos indicadores de la Región de Antofagasta y sus comunas. En particular nos enfocamos en las cifras de pobreza multidimensional y por ingresos; caracteristicas de la población y en especial de la población en etapa escolar y de estudios superiores; la evoluciooo4ón del desempleo en la regioo4ón en los últimos años y como sus programas pueden ayudar primero en la educacioo4ón de los niños y niñas de Sierra Gorda y Baquedano, y en su futura inserción laboral.  


Con este analisis del programa becas de educación ustedes pueden ver desempeño social de los programas realizados de manera directa o a través de la gestión de terceras parte y recomendaciones para aumentar su impacto social.



Por último, en la tabla nº1 se observa que las donaciones de Anglo American registradas en el MDS solo se concentran en 6 beneficiarios; Corporación la Montaña, Enseña Chile, Mi Parque, Techo, Technoserve y Fondo Esperanza. 


```{r echo = FALSE, results = 'table'}
#kable(Donaciones_donatarioRank[,], caption = "Tabla 1: Donaciones por Institución Beneficiaria, 2009-2016, MM de pesos")

shinyApp(
  ui = fluidPage(DTOutput('tbl')),
  server = function(input, output) {
    output$tbl = renderDT(
      RankingAnglo, options = list(lengthChange = FALSE), rownames=FALSE, caption = "Tabla 1: Donaciones por Institución Beneficiaria, MM$") 
  }
)
```

```{r echo = FALSE, results = 'table'}
#kable(Donaciones_donatarioRank[,], caption = "Tabla 1: Donaciones por Institución Beneficiaria, 2009-2016, MM de pesos")

ui<-  dashboardPage(header, sidebar,body)

server <- function(input, output) {
    z <- reactive({
    Pob_Multi %>% filter(comuna %in% input$comuna) %>% select("2015")
  })
  
    k <- reactive({
    Pob_Multi %>% filter(comuna %in% input$comuna) %>% select("2017")
  })
  
  output$plot <- renderPlotly(
    fig <- plot_ly(
      type = 'scatterpolar',
      fill = 'toself',
      mode='lines'
    ) %>%
      add_trace(
        r = as.numeric(unlist(z())),
        theta = input$comuna, 
        fillcolor='#1DC9A1',
        line=list(color='rgba(29, 201, 161, 1)'),
        opacity=0.8,
        name = '2015')  %>%
      add_trace(
        r = as.numeric(unlist(k())),
        theta = input$comuna, 
        name = '2017',
        fillcolor='#F1CB31',
        opacity=0.8,
        line=list(color='rgba(241, 203, 49, 1)')
      )
  )
  
  
  output$Pob_Multi <- DT::renderDataTable(DT::datatable({
          data <- Pob_Multi
          if (input$comuna != "Elija Comuna") {
            data <- data %>% filter (comuna %in% input$comuna)
          }
          data 
          },
                rownames=FALSE,
                escape = FALSE,
                class = "nowrap stripe",
                extensions = list('FixedHeader','Scroller'),
                options = list(
                  scrollX = TRUE,
                  scroller = TRUE,
                 paging=FALSE,
                 searching = FALSE,
                  info=0,
                  lengthChange=FALSE,
                  initComplete = JS("
                  function(settings, json) {
                    $(this.api().table().header()).css({
                      'background-color': '#2797C9',
                      'color': '#fff',
                    });
                  }")
                )
                ))

  
  a <- reactive({
    Pov_Ing %>% filter(comuna %in% input$comuna_ing) %>% select("2015")
  })
  
  b <- reactive({
    Pov_Ing %>% filter(comuna %in% input$comuna_ing) %>% select("2017")
  })
  
  output$Pov_Ing_radar <- renderPlotly(
    fig <- plot_ly(
      type = 'scatterpolar',
      mode='lines'
    ) %>%
      add_trace(
        r = as.numeric(unlist(a())),
        theta = input$comuna_ing, 
        name = '2015',
        fill='toself',
        opacity=0.8,
        fillcolor='#5BCBFD',
        line=list(color='rgba(91, 203, 253, 1)'))  %>%
      add_trace(
        r = as.numeric(unlist(b())),
        theta = input$comuna_ing, 
        name = '2017',
        fill='toself',
        opacity=0.8,
        fillcolor='#EFC000',
        line=list(color='rgba(239, 192, 0, 1)'))
    
  )
    
    output$Pov_Ing <- renderTable({
    Pov_Ing[, c("comuna", input$variable), drop = FALSE]
  },
  rownames=FALSE,
  escape = FALSE,
  class = "nowrap stripe",
  extensions = list('FixedHeader','Scroller'),
  options = list(
    scrollX = TRUE,
    scroller = TRUE,
    DOM='t',
    #searching = FALSE,
    pageLength = 10,
    lengthMenu = list(c(10, 50, 100, 200), c('10', '50', '100', '200')),
    initComplete = JS("
    function(settings, json) {
      $(this.api().table().header()).css({
        'background-color': '#2797C9',
        'color': '#fff',
      });
    }")
  )
  )
  
  

        output$Desempleo <-renderDT(Desempleo, # reactive data
                                rownames=FALSE,
                                escape = FALSE,
                                class = "nowrap stripe",
                                extensions = list('FixedHeader','Scroller'),
                                options = list(
                                  scrollX = TRUE,
                                  scroller = TRUE,
                                  DOM='t',
                                  #searching = FALSE,
                                  pageLength = 10,
                                  lengthMenu = list(c(10, 50, 100, 200), c('10', '50', '100', '200')),
                                  initComplete = JS("
    function(settings, json) {
      $(this.api().table().header()).css({
        'background-color': '#5BCBFD',
        'color': '#fff',
      });
    }")
                                )
    )
      
       

    output$Mat <-renderDT(Mat_hist, # reactive data
                                rownames=FALSE,
                                escape = FALSE,
                                class = "nowrap stripe",
                                extensions = list('FixedHeader','Scroller'),
                                options = list(
                                  scrollX = TRUE,
                                  scroller = TRUE,
                                  DOM='t',
                                  #searching = FALSE,
                                  pageLength = 10,
                                  lengthMenu = list(c(10, 50, 100, 200), c('10', '50', '100', '200')),
                                  initComplete = JS("
    function(settings, json) {
      $(this.api().table().header()).css({
        'background-color': '#EFC000',
        'color': '#fff',
      });
    }")
                                )
    )

    output$data_Emp <- renderTable({
      RII_Empleo[, c("Comuna", "Remunerado", input$variable), drop = FALSE]
    }, 
    rownames=FALSE,
  #  escape = FALSE,
  #  class = "nowrap stripe",
  #  extensions = list('FixedHeader','Scroller'),
    options = list(
      scrollX = TRUE,
      scroller = TRUE,
      DOM='t',
      #searching = FALSE,
    #  pageLength = 10,
    #  lengthMenu = list(c(10, 50, 100, 200), c('10', '50', '100', '200')),
      initComplete = JS("
    function(settings, json) {
      $(this.api().table().header()).css({
        'background-color': '#5BCBFD',
        'color': '#fff',
      });
    }")
    )
    )

    output$Educ <-renderDT(RII_Educ,  
                           rownames=TRUE,
                           escape = FALSE,
                           class = "nowrap stripe",
                           extensions = list('FixedHeader','Scroller'),
                           options = list(
                             scrollX = TRUE,
                             scroller = TRUE,
                             DOM='t',
                             lengthChange=FALSE,
                             paging=FALSE,
                            searching = FALSE,
                            info=0,
                            initComplete = JS("
    function(settings, json) {
      $(this.api().table().header()).css({
        'background-color': '#EFC000',
        'color': '#fff',
      });
    }")
                           )
    )
    
    output$becas <-renderDT(becas, 
                            rownames=FALSE,
                            escape = FALSE,
                            class = "nowrap stripe",
                            extensions = list('FixedHeader','Scroller'),
                            options = list(
                #              columnDefs = list(list(visible=FALSE, target=1)),
                              scrollX = TRUE,
                              scroller = TRUE,
                              DOM='t',
                              lengthChange=FALSE,
                              searching = FALSE,
                              paging=FALSE,
                              info=0,
                              initComplete = JS("
                                  function(settings, json) {
                                    $(this.api().table().header()).css({
                                      'background-color': '#5BCBFD',
                                      'color': '#fff',
                                    });
                                  }")
                            ))
                            
    output$BECAS <-renderPlotly({
      plot_ly(becas, x = ~Año, name='Cantidad Becas') %>% 
        add_trace(y = ~Total, name = 'Total Becas', type = 'scatter', mode = 'lines', line=list(color='rgba(29, 201, 161, 1)')) %>%
        add_trace(y = ~Media, name = 'Escuela Media', type = 'scatter', mode = 'lines', line=list(color='rgba(239, 192, 0, 1)')) %>%
        add_trace(y = ~Superior, name = 'Nivel Superior', type = 'scatter', mode = 'lines', line = list(color = 'rgba(91, 203, 253, 1)')) 
      })
  
  f <- reactive({
      nomina %>% filter(comuna %in% input$comunasPer) %>% select(empleabilidad)
    })
    
  g <- reactive({
      nomina %>% filter(comuna %in% input$comunasPer) %>% select(continuidad)
    })
  
  output$DESEMPEÑO<-renderPlotly(
    fig <- plot_ly(x = ~as.numeric(unlist(aggcomunas %>% filter(comuna=="Baquedano") %>% select(Año))), 
                   y = ~as.numeric(unlist(aggcomunas %>% filter(comuna=="Baquedano") %>% select(input$indicador))), 
                   name = 'Baquedano', type = 'scatter', mode = 'lines', fill = 'tonexty',fillcolor = '#5BCBFD') %>% 
      add_trace(x = ~as.numeric(unlist(aggcomunas %>% filter(comuna=="Sierra Gorda") %>% select(Año))), 
                y = ~as.numeric(unlist(aggcomunas %>% filter(comuna=="Sierra Gorda") %>% select(input$indicador))), 
                name = 'Sierra Gorda', fillcolor = '#EFC000') %>% 
      layout(title = 'Desempeño esperado beneficiarios',
             xaxis = list(title = "Año",
                          showgrid = FALSE),
             yaxis = list(title = input$indicador,
                          showgrid = FALSE,
                          ticksuffix = ''))
    )
  
  output$Matriculas <- renderPlotly(
    fig<-plot_ly(Mat_hist, x = ~ Mat_hist %>% filter(año %in% input$año) %>% select("Comuna"), y = ~ as.numeric(unlist(Mat_hist %>% filter(año %in% input$año) %>% select("Basica"))), type = 'bar', name = 'Básica', marker = list(color = 'rgba(91, 203, 253)')) %>%
      add_trace(y = ~ as.numeric(unlist(Mat_hist %>% filter(año %in% input$año) %>% select("Media.HC"))), name = 'Media Humanista-Científico', marker = list(color = 'rgb(239, 192, 0)')) %>%
      add_trace(y = ~ as.numeric(unlist(Mat_hist %>% filter(año %in% input$año) %>% select("Media.TP"))), name = 'Media Tecnico-Profesional', marker = list(color = 'rgb(29, 201, 161)')) %>% 
      add_trace(y = ~ as.numeric(unlist(Mat_hist %>% filter(año %in% input$año) %>% select("Otros"))), name = 'Otros', marker = list(color = 'rgb(112, 112, 112)'))%>% 
      layout(yaxis = list(title = 'Count'),
             xaxis = list(title = ""),
             yaxis = list(title = ""),
             legend = list(orientation = 'h'),
             barmode = 'stack'))
  
  filtro2<-reactive({
    becados_tincidencia %>% filter(Año == input$año_media)%>% select("tasa_Media")
  })
  
  output$incidencia_media<-renderPlotly(
    figuras<-plot_ly(
      domain = list(x = c(0, 1), y = c(0, 1)),
      value = filtro2()$tasa_Media[1]*100,
      gauge = list(
        axis =list(range = list(NULL, 100)),
        bar = list(color =  '#5BCBFD')),
      type = "indicator",
      mode = "gauge+number")%>%
      layout(margin = list(l=20,r=30))
  )
  filtro3<-reactive({
    becados_tincidencia %>% filter(Año == input$año_superior)%>% select("tasa_Superior")
  })
  
  output$incidencia_superior<-renderPlotly(
    figuras<-plot_ly(
      domain = list(x = c(0, 1), y = c(0, 1)),
      value = filtro3()$tasa_Superior[1]*100,
      gauge = list(
        axis =list(range = list(NULL, 100)),
        bar = list(color =  '#EFC000')),
      type = "indicator",
      mode = "gauge+number")%>%
      layout(margin = list(l=20,r=30))
  )
  
  filtro<-reactive({
    pob_hm %>% filter(Nom_Com == input$comuna_pobhm)
  })
  
  long <-reactive({
    filtro() %>% gather(Nom_Com,Proporcion, Hombre:Mujeres)
  })
  
  colors <- c('rgb(29, 201, 161)', 'rgb(239, 192, 0)')
  
  output$pob_hm <- renderPlotly(
    figura<-plot_ly(
      long(), labels = ~Nom_Com, values = ~Proporcion, type = 'pie',
      textposition = 'inside',
      textinfo = 'label+percent',
      insidetextfont = list(color = '#FFFFFF'),
      marker = list(colors = colors,
                    line = list(color = '#FFFFFF', width = 1)),
      showlegend = FALSE)
  )

  filtro_hm<-reactive({
    pob_tipoeduc %>% filter(Comuna == input$comuna_tipoeduc)
  })
  
  long_hm <-reactive({
    filtro_hm() %>% gather(Comuna,Proporcion, Parvulo:Superior)
  })
  
  colors_educ <- c('rgb(29, 201, 161)', 'rgb(239, 192, 0)', 'rgb(91, 203, 253)', 'rgb(112, 112,112)')
  
  output$pob_tipoeduc <- renderPlotly(
    figura<-plot_ly(
      long_hm(), labels = ~Comuna, values = ~Proporcion, type = 'pie',
      textposition = 'inside',
      textinfo = 'label+percent',
      insidetextfont = list(color = '#FFFFFF'),
      marker = list(colors = colors_educ,
                    line = list(color = '#FFFFFF', width = 1)),
      showlegend = FALSE)
  )
  
  output$Ingresos<-renderPlotly(
    fig <- plot_ly(ingresosAño, x = ~Año, y = ~ingmax, type = 'scatter', mode = 'lines',
                   line = list(color = 'rgba(29, 201, 161,1)'),
                   showlegend = FALSE, name = 'Máximo') %>% 
      add_trace(y = ~ingmin, type = 'scatter', mode = 'lines',
                fill = 'tonexty', fillcolor='rgba(29, 201, 161,0.2)', line = list(color = 'rgba(29, 201, 161,1)'),
                showlegend = FALSE, name = 'Mínimo') %>% 
      layout(title = "Ingresos mínimos y máximos esperados de beneficiarios",
             paper_bgcolor='rgb(255,255,255)', plot_bgcolor='rgb(229,229,229)',
             xaxis = list(title = "Año",
                          gridcolor = 'rgb(255,255,255)',
                          showgrid = TRUE,
                          showline = FALSE,
                          showticklabels = TRUE,
                          tickcolor = 'rgb(127,127,127)',
                          ticks = 'outside',
                          zeroline = FALSE),
             yaxis = list(title = "Ingresos (Miles de pesos)",
                          gridcolor = 'rgb(255,255,255)',
                          showgrid = TRUE,
                          showline = FALSE,
                          showticklabels = TRUE,
                          tickcolor = 'rgb(127,127,127)',
                          ticks = 'outside',
                          zeroline = FALSE))
  )
  
}

shinyApp(ui, server)
  
  
```


# 1.1. Donaciones georefenrenciadas

En el mapa podemos observar los programas y su ubicacioón a nivel nacional. La data georefenciada muestra que las donaciones se sitúan en la región de Antofagasta, Metropolitana, Maule y Bio Bio, siendo la región Metropolitana la con mayor intervención de proyectos. 



# 2. Estadisticas

En los siguientes gráficos se ve las donaciones realizadas por Anglo American por año y por filial en el marco de la ley de donaciones sociales. Se observa que desde 2009 a la fecha, existio un peak en terminos de monto de donaciones entre 2010 y 2011, que puede haber sido causado por el terremoto. En terminos del promedio de montos, estos se situan en el rango de 0 a 100 millones.



# 3. Portfolio de Inversiones

En esta sección se muestra el portfolio de inversiones sociales de Anglo y el benchmarking de otras entidades con sus respectivos indicadores de impacto social.

Nota indicadores computados con datos publicos y FECUs sociales
